---
title: "Surv 727 Assignment #4"
author: "Ted Wenner"
date: "11/04/2025"
output:
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(odbc)
library(bigrquery)
library(DBI)
library(dbplyr)
```

#Github Repo Link
```{}
https://github.com/TedWenner/Surv727-Assignment-4
```

#Paste your project ID into this chunk
```{r}
project<- "surv727assignment4"
```

#Chicago Crime Data
```{r}
con <- dbConnect(
bigrquery::bigquery(),
project = "bigquery-public-data",
dataset = "chicago_crime",
billing = project
)
con

```

#Available Tables
``` {r}
dbListTables(con)
```

#Write a first query that counts the number of rows of the ‘crime‘ table in the year 2016. Use code chunks with {sql connection = con} in order to write SQL code within the document
``` {sql connection= con, message = FALSE}        
SELECT count(primary_type) AS primary_count, count(*) AS overall_count
FROM crime
WHERE year = 2015
LIMIT 10;

```

#Next, count the number of arrests grouped by primary_type in 2016. Note that is a somewhat similar task as above, with some adjustments on which rows should be considered. Sort the results, i.e. list the number of arrests in a descending order.
```{sql connection= con, message = FALSE} 
SELECT primary_type, COUNT(*) AS num_arrests
FROM crime
WHERE arrest = TRUE AND EXTRACT(YEAR FROM date) = 2016
GROUP BY primary_type
ORDER BY num_arrests DESC;

```

#Count the number of arrests grouped by hour of the day in 2016. You can extract the latter information from date via EXTRACT(HOUR FROM date). Which time of the day is associated with the most arrests?
``` {sql connection= con, message = FALSE}
SELECT EXTRACT(HOUR FROM date) AS hour_of_day, COUNT(*) AS num_arrests
FROM crime 
WHERE arrest = TRUE AND EXTRACT(YEAR FROM date) = 2016
GROUP BY hour_of_day
ORDER BY num_arrests DESC;

# The time of day that is most associated with arrests is hour 19 with 3843
```

#Focus only on HOMICIDE and count the number of arrests for this incident type, grouped by year. List the results in descending order.
```{sql connection= con, message = FALSE} 
SELECT EXTRACT(YEAR FROM date) AS year, COUNT(*) AS num_arrests
FROM crime
WHERE primary_type = "HOMICIDE" AND arrest = TRUE
GROUP BY year
ORDER BY num_arrests DESC;


```

#Find out which districts have the highest numbers of arrests in 2015 and 2016. That is, count the number of arrests in 2015 and 2016, grouped by year and district. List the results in descending order.
```{sql connection= con, message = FALSE}
SELECT EXTRACT(YEAR FROM date) AS year, COUNT(*) AS num_arrests
FROM crime
WHERE arrest = TRUE AND EXTRACT(YEAR FROM date) IN (2015,2016)
GROUP BY year, district
ORDER BY num_arrests DESC;

```

#Lets switch to writing queries from within R via the DBI package. Create a query object that counts the number of arrests grouped by primary_type of district 11 in year 2016. The results should be displayed in descending order.
```{r}
query<- "SELECT primary_type, COUNT(*) AS num_arrests
  FROM crime
  WHERE district = 11 AND arrest = TRUE 
  AND EXTRACT(YEAR FROM date) = 2016
  GROUP BY
    primary_type
  ORDER BY
    num_arrests DESC"

query1<- dbSendQuery(con, query)

queryresults<- dbFetch(query1)

print(queryresults )

```

#Try to write the very same query, now using the dbplyr package. For this, you need to first map the crime table to a tibble object in R.
```{r}
crime_tbl <- tbl(con, "crime")

crime_results1 <- tbl(con, "crime") |>
  filter(district == 11, 
         arrest, 
         date >= "2016-01-01", date < "2017-01-01") |>
  count(primary_type, name = "num_arrests", sort = TRUE) |>
  collect()

print(crime_results1)

```

#Again, count the number of arrests grouped by primary_type of district 11 in year 2016, now using dplyr syntax.
```{r}
crime_results2 <- crime_tbl |>
  filter(district == 11,
         arrest,
         date >= "2016-01-01", date < "2017-01-01") |>
  count(primary_type, name = "num_arrests", sort = TRUE) |>
  collect()

print(crime_results2)

```

#Count the number of arrests grouped by primary_type and year, still only for district 11.Arrange the result by year.
```{r}
crime_results3 <- crime_tbl |>
  filter(district == 11, arrest) |>
  mutate(year = year(date)) |>
  count(primary_type, year, name = "num_arrests")|>
  arrange(year) %>%
  collect()

print(crime_results3)
```

#Assign the results of the query above to a local R object.
```{r}
crime_results3
```

#Confirm that you pulled the data to the local environment by displaying the first ten rows of the saved data set.Close the connection
```{r}
head(crime_results3, 10)
dbDisconnect(con)
```